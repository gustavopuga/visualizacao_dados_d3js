<!DOCTYPE html>
<html>

<head>
    <style>
        .country {
            fill: gray;
            stroke: gray;
            stroke-width: .5;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.15.0/d3.min.js"></script>

    <title>Teste Choropleth</title>
</head>

<body>

    <h1>População dos Estados Brasileiros</h1>
    <p id="chart"></p>

    <script>

        const width = 960;
        const height = 500;

        const svg = d3.select("#chart").append("svg")
            .attr("width", width).attr("height", height);

        //Legenda
        const bbox = d3.select("#chart").node().getBoundingClientRect();

        // Projeção 
        const projection = d3.geoMercator();

        // Criando a função que irá gerar a projetção
        const geoPath = d3.geoPath()
            .projection(projection);

        // Escala de cores
        const colorScale = d3.scaleSqrt(["hsla(240,100%,50%,.1)", "red"]);

        const map = {};

        // Lendo geojson e csv com as informações sobre a população e código do ibge
        Promise.all([
            d3.json('https://raw.githubusercontent.com/gustavopuga/visualizacao_dados_d3js/master/datasets/estados_br.geojson'),
            d3.csv('https://raw.githubusercontent.com/gustavopuga/visualizacao_dados_d3js/master/datasets/estados_br_pop.csv', function (row) {
                return {
                    cod_ibge: +row.cod_ibge,
                    population: +row.populacao,
                    uf: row.uf
                }
            })
        ]).then(function ([shapes, thematic]) {
            //a ordem das variaveis do array segue a função promise

            // save in a global context
            map.features = shapes.features;

            // add data to properties
            map.features.forEach(function (d) {
                const entry = thematic.filter(t => t.cod_ibge == d.properties.codigo_ibg)[0];
                if (entry) {
                    d.properties.population = entry.population;
                    d.properties.uf = entry.uf;
                }
            })

            projection.fitSize([width, height], shapes);

            // configure the scale
            colorScale.domain(d3.extent(map.features, d => d.properties.population));
            draw();
        });

        let mouseOver = function (d) {
            d3.selectAll(".state")
                .transition()
                .duration(200)
                .style("opacity", .5);
            d3.select(this)
                .transition()
                .duration(200)
                .style("opacity", 1)
                .style("stroke", "black");
            d3.select(this)
                .append('text')
                .style('font-size', d => fontScale(d.properties.population))
                .text(d.properties.uf);
        }

        let mouseLeave = function (d) {
            d3.selectAll(".state")
                .transition()
                .duration(200)
                .style("opacity", .8);
            d3.select(this)
                .transition()
                .duration(200)
                .style("stroke", "transparent")
            d3.select(this).select('text').remove();
        }

        function draw() {
            svg.selectAll("path.country")
                .data(map.features)
                .enter()
                .append("path")
                .attr("class", "state")
                .attr('d', geoPath)
                .style("fill", d => colorScale(d.properties.population))
                .on("mouseover", mouseOver)
                .on("mouseleave", mouseLeave)
        }

    </script>

    </script>

</body>

</html>