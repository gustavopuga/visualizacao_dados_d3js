<!DOCTYPE html>
<html>

    <head>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.11.0/d3.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.5/dat.gui.js"></script>
        <script src="https://unpkg.com/cartogram-chart@1"></script>
        <script src="https://unpkg.com/d3-scale-chromatic"></script>
    
        <style>body { margin: 0; }</style>
    </head>
    
    <body>
    <div id="brazil"></div>
    
    <script>
        // Controls
        const gui = new dat.GUI();
    
        const colorScale = d3.scaleSequential(d3.interpolateYlOrBr);
    
        const cartogram = Cartogram()
            .valFormatter(n => n.toPrecision(3))
            (document.getElementById('brazil'));
    
        d3.json('https://raw.githubusercontent.com/gustavopuga/visualizacao_dados_d3js/master/json/estados_br.json', (error, brazil) => {
            if (error) throw error;
    
            // exclude antarctica
            /*world.objects.countries.geometries.splice(
                world.objects.countries.geometries.findIndex(d => d.properties.ISO_A2 === 'AQ'),
                1
            );*/
    
            let ccData;
    
            cartogram
                .topoJson(brazil)
                .topoObjectName('estados')
                .value(({ properties: { id } }) => ccData[id])
                .color(({ properties: { id } }) => colorScale(ccData[id]))
                .label(({ properties: p }) => `${p.nome} (${p.id})`)
                .onClick(d => console.info(d));
    
            const controls = { 'Iterations': 15, 'Randomize': () => { genVals(); render(); }};
            gui.add(controls, 'Iterations', 1, 40).step(1).onChange(render);
            gui.add(controls, 'Randomize');
    
            genVals();
            render();
    
            //
    
            function genVals() {
                ccData = Object.assign(...brazil.objects.estados.geometries
                    .map(({ properties: { id } }) => ({ [id]: Math.random() }))
                );
            }
    
            function render() {
                cartogram.iterations(controls.Iterations);
            }
        });
    </script>
    </body>

</html>